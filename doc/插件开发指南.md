# Airdropz 插件开发指南

## 插件系统概述

Airdropz 支持两种类型的插件：**JavaScript 插件** 和 **Python 插件**。每种类型都有其特定的用途和优势。

### 插件类型对比

| 特性 | JavaScript 插件 | Python 插件 |
|------|----------------|-------------|
| **执行环境** | 主进程内 | 独立进程 |
| **性能** | 高性能，无进程间通信开销 | 中等性能，有 IPC 开销 |
| **API 访问** | 完整 Electron API 访问 | 受限，通过 stdin/stdout 通信 |
| **依赖管理** | npm 包管理 | pip 包管理 |
| **调试** | 直接调试 | 需要独立调试 |
| **适用场景** | UI 相关、Electron 集成 | 数据处理、机器学习、爬虫 |

## JavaScript 插件开发

### 1. 插件结构

```
plugins/my-js-plugin/
├── index.js          # 插件主文件
└── manifest.json     # 插件配置文件
```

### 2. 创建插件

#### 步骤 1: 创建插件目录

```bash
mkdir plugins/my-js-plugin
cd plugins/my-js-plugin
```

#### 步骤 2: 创建 manifest.json

```json
{
  "name": "my-js-plugin",
  "type": "js",
  "entry": "index.js",
  "version": "1.0.0",
  "description": "我的 JavaScript 插件",
  "author": "Your Name",
  "dependencies": {
    "some-package": "^1.0.0"
  }
}
```

#### 步骤 3: 创建插件主文件

```javascript
// plugins/my-js-plugin/index.js
const { BrowserWindow } = require('electron');

module.exports = (context) => {
  let myData = {};

  // 插件初始化函数
  function init() {
    console.log('My JS Plugin initialized');
    
    // 注册插件动作
    context.registerAction('myAction', myAction);
    context.registerAction('getData', getData);
    context.registerAction('setData', setData);
  }

  // 示例动作：处理数据
  async function myAction(params) {
    try {
      console.log('My action called with:', params);
      
      // 执行插件逻辑
      const result = await processData(params);
      
      return {
        success: true,
        data: result
      };
    } catch (error) {
      console.error('Plugin action error:', error);
      return {
        success: false,
        error: error.message
      };
    }
  }

  // 获取数据
  function getData() {
    return myData;
  }

  // 设置数据
  function setData(data) {
    myData = { ...myData, ...data };
    return { success: true };
  }

  // 数据处理函数
  async function processData(params) {
    // 模拟异步处理
    await new Promise(resolve => setTimeout(resolve, 1000));
    
    return {
      processed: true,
      timestamp: Date.now(),
      input: params
    };
  }

  // 插件清理函数
  function cleanup() {
    console.log('My JS Plugin cleaning up');
    myData = {};
  }

  // 返回插件接口
  return {
    init,
    cleanup,
    // 可选：暴露其他方法供其他插件使用
    utils: {
      processData
    }
  };
};
```

### 3. 高级 JavaScript 插件示例

#### 文件操作插件

```javascript
// plugins/file-manager/index.js
const fs = require('fs').promises;
const path = require('path');

module.exports = (context) => {
  const baseDir = path.join(require('electron').app.getPath('userData'), 'files');

  async function init() {
    // 确保目录存在
    await fs.mkdir(baseDir, { recursive: true });
    
    context.registerAction('readFile', readFile);
    context.registerAction('writeFile', writeFile);
    context.registerAction('listFiles', listFiles);
    context.registerAction('deleteFile', deleteFile);
  }

  async function readFile(filename) {
    try {
      const filePath = path.join(baseDir, filename);
      const content = await fs.readFile(filePath, 'utf8');
      return { success: true, content };
    } catch (error) {
      return { success: false, error: error.message };
    }
  }

  async function writeFile(filename, content) {
    try {
      const filePath = path.join(baseDir, filename);
      await fs.writeFile(filePath, content, 'utf8');
      return { success: true };
    } catch (error) {
      return { success: false, error: error.message };
    }
  }

  async function listFiles() {
    try {
      const files = await fs.readdir(baseDir);
      return { success: true, files };
    } catch (error) {
      return { success: false, error: error.message };
    }
  }

  async function deleteFile(filename) {
    try {
      const filePath = path.join(baseDir, filename);
      await fs.unlink(filePath);
      return { success: true };
    } catch (error) {
      return { success: false, error: error.message };
    }
  }

  return { init };
};
```

## Python 插件开发

### 1. 插件结构

```
plugins/my-python-plugin/
├── my_plugin.py      # Python 脚本
└── manifest.json     # 插件配置文件
```

### 2. 创建 Python 插件

#### 步骤 1: 创建插件目录

```bash
mkdir plugins/my-python-plugin
cd plugins/my-python-plugin
```

#### 步骤 2: 创建 manifest.json

```json
{
  "name": "my-python-plugin",
  "type": "python",
  "entry": "my_plugin.py",
  "version": "1.0.0",
  "description": "我的 Python 插件",
  "author": "Your Name",
  "dependencies": {
    "requests": "^2.28.0",
    "pandas": "^1.5.0"
  }
}
```

#### 步骤 3: 创建 Python 脚本

```python
# plugins/my-python-plugin/my_plugin.py
import sys
import json
import time
import requests

class MyPythonPlugin:
    def __init__(self):
        self.data = {}
        self.running = True
    
    def process_command(self, command):
        """处理来自主进程的命令"""
        try:
            if command.strip() == "get_status":
                return self.get_status()
            elif command.strip() == "get_data":
                return self.get_data()
            elif command.startswith("set_data:"):
                data = command.split(":", 1)[1]
                return self.set_data(json.loads(data))
            elif command.startswith("fetch_url:"):
                url = command.split(":", 1)[1]
                return self.fetch_url(url)
            elif command.strip() == "shutdown":
                self.running = False
                return {"status": "shutdown"}
            else:
                return {"error": "Unknown command"}
        except Exception as e:
            return {"error": str(e)}
    
    def get_status(self):
        """获取插件状态"""
        return {
            "status": "running",
            "data_count": len(self.data),
            "timestamp": time.time()
        }
    
    def get_data(self):
        """获取存储的数据"""
        return {"data": self.data}
    
    def set_data(self, new_data):
        """设置数据"""
        self.data.update(new_data)
        return {"status": "success", "message": "Data updated"}
    
    def fetch_url(self, url):
        """获取 URL 内容"""
        try:
            response = requests.get(url, timeout=10)
            return {
                "status": "success",
                "url": url,
                "status_code": response.status_code,
                "content_length": len(response.content)
            }
        except Exception as e:
            return {"status": "error", "message": str(e)}

def main():
    plugin = MyPythonPlugin()
    
    # 主循环：监听 stdin 输入
    for line in sys.stdin:
        if not plugin.running:
            break
            
        command = line.strip()
        if command:
            result = plugin.process_command(command)
            print(json.dumps(result))
            sys.stdout.flush()

if __name__ == "__main__":
    main()
```

### 3. 高级 Python 插件示例

#### 数据处理插件

```python
# plugins/data-processor/data_processor.py
import sys
import json
import pandas as pd
import numpy as np
from datetime import datetime

class DataProcessor:
    def __init__(self):
        self.datasets = {}
    
    def process_command(self, command):
        try:
            parts = command.split(":", 1)
            action = parts[0]
            params = json.loads(parts[1]) if len(parts) > 1 else {}
            
            if action == "load_csv":
                return self.load_csv(params)
            elif action == "process_data":
                return self.process_data(params)
            elif action == "get_stats":
                return self.get_stats(params)
            elif action == "export_json":
                return self.export_json(params)
            else:
                return {"error": "Unknown action"}
        except Exception as e:
            return {"error": str(e)}
    
    def load_csv(self, params):
        """加载 CSV 文件"""
        filename = params.get("filename")
        dataset_name = params.get("name", "default")
        
        try:
            df = pd.read_csv(filename)
            self.datasets[dataset_name] = df
            return {
                "status": "success",
                "rows": len(df),
                "columns": list(df.columns)
            }
        except Exception as e:
            return {"status": "error", "message": str(e)}
    
    def process_data(self, params):
        """处理数据"""
        dataset_name = params.get("name", "default")
        operation = params.get("operation")
        
        if dataset_name not in self.datasets:
            return {"status": "error", "message": "Dataset not found"}
        
        df = self.datasets[dataset_name]
        
        if operation == "filter":
            column = params.get("column")
            value = params.get("value")
            filtered_df = df[df[column] == value]
            self.datasets[f"{dataset_name}_filtered"] = filtered_df
            return {"status": "success", "rows": len(filtered_df)}
        
        elif operation == "aggregate":
            group_by = params.get("group_by")
            agg_column = params.get("agg_column")
            agg_func = params.get("agg_func", "sum")
            
            result = df.groupby(group_by)[agg_column].agg(agg_func).to_dict()
            return {"status": "success", "result": result}
        
        return {"status": "error", "message": "Unknown operation"}
    
    def get_stats(self, params):
        """获取数据统计"""
        dataset_name = params.get("name", "default")
        
        if dataset_name not in self.datasets:
            return {"status": "error", "message": "Dataset not found"}
        
        df = self.datasets[dataset_name]
        stats = df.describe().to_dict()
        
        return {
            "status": "success",
            "stats": stats,
            "shape": df.shape
        }
    
    def export_json(self, params):
        """导出为 JSON"""
        dataset_name = params.get("name", "default")
        
        if dataset_name not in self.datasets:
            return {"status": "error", "message": "Dataset not found"}
        
        df = self.datasets[dataset_name]
        json_data = df.to_dict(orient="records")
        
        return {
            "status": "success",
            "data": json_data,
            "count": len(json_data)
        }

def main():
    processor = DataProcessor()
    
    for line in sys.stdin:
        command = line.strip()
        if command:
            result = processor.process_command(command)
            print(json.dumps(result))
            sys.stdout.flush()

if __name__ == "__main__":
    main()
```

## 插件通信

### 1. JavaScript 插件调用

```javascript
// 在 Electron 主进程中调用插件
ipcMain.handle('call-plugin', async (event, pluginName, action, ...args) => {
  const plugin = pluggableElectron.usePlugins().find(p => p.name === pluginName);
  if (plugin && plugin.actions[action]) {
    return await plugin.actions[action](...args);
  }
  throw new Error(`Plugin ${pluginName} or action ${action} not found`);
});
```

### 2. Python 插件调用

```javascript
// 在 PluginManager 中调用 Python 插件
async function callPythonPlugin(pluginPath, command) {
  const pythonProcess = this.pythonProcesses.get(pluginPath);
  if (!pythonProcess || !pythonProcess.stdin.writable) {
    throw new Error('Python plugin not available');
  }
  
  return new Promise((resolve, reject) => {
    let output = '';
    
    const onData = (data) => {
      output += data.toString();
      try {
        const result = JSON.parse(output.trim());
        pythonProcess.stdout.removeListener('data', onData);
        resolve(result);
      } catch (e) {
        // 继续接收数据
      }
    };
    
    pythonProcess.stdout.on('data', onData);
    pythonProcess.stdin.write(command + '\n');
    
    // 超时处理
    setTimeout(() => {
      pythonProcess.stdout.removeListener('data', onData);
      reject(new Error('Plugin timeout'));
    }, 5000);
  });
}
```

## 插件调试

### 1. JavaScript 插件调试

```javascript
// 在插件中添加调试日志
function myAction(params) {
  console.log('Plugin debug:', {
    action: 'myAction',
    params: params,
    timestamp: new Date().toISOString()
  });
  
  // 插件逻辑...
}
```

### 2. Python 插件调试

```python
# 在 Python 插件中添加调试日志
import logging

logging.basicConfig(level=logging.DEBUG)
logger = logging.getLogger(__name__)

def process_command(self, command):
    logger.debug(f"Processing command: {command}")
    
    try:
        # 插件逻辑...
        result = {"status": "success"}
        logger.debug(f"Command result: {result}")
        return result
    except Exception as e:
        logger.error(f"Command error: {e}")
        return {"error": str(e)}
```

### 3. 独立测试 Python 插件

```bash
# 直接运行 Python 插件进行测试
cd plugins/my-python-plugin
python3 my_plugin.py

# 输入测试命令
get_status
set_data:{"key": "value"}
get_data
```

## 插件打包

### 1. JavaScript 插件

JavaScript 插件无需额外打包，直接复制到插件目录即可。

### 2. Python 插件打包

```bash
# 安装 PyInstaller
pip install pyinstaller

# 打包 Python 插件
cd plugins/my-python-plugin
pyinstaller --onefile my_plugin.py

# 将生成的可执行文件复制到插件目录
cp dist/my_plugin my_plugin
```

## 插件最佳实践

### 1. 错误处理

```javascript
// JavaScript 插件错误处理
async function myAction(params) {
  try {
    // 参数验证
    if (!params || typeof params !== 'object') {
      throw new Error('Invalid parameters');
    }
    
    // 业务逻辑
    const result = await processData(params);
    
    return {
      success: true,
      data: result
    };
  } catch (error) {
    console.error('Plugin error:', error);
    return {
      success: false,
      error: error.message
    };
  }
}
```

### 2. 资源清理

```javascript
// JavaScript 插件资源清理
function cleanup() {
  // 清理定时器
  if (this.intervalId) {
    clearInterval(this.intervalId);
  }
  
  // 清理事件监听器
  if (this.eventListener) {
    this.eventListener.remove();
  }
  
  // 清理数据
  this.data = null;
}
```

### 3. 配置管理

```json
// manifest.json 配置示例
{
  "name": "my-plugin",
  "type": "js",
  "entry": "index.js",
  "version": "1.0.0",
  "description": "My Plugin Description",
  "author": "Author Name",
  "dependencies": {
    "lodash": "^4.17.21"
  },
  "config": {
    "defaultSettings": {
      "timeout": 5000,
      "retries": 3
    }
  }
}
```

### 4. 性能优化

```javascript
// 使用缓存避免重复计算
const cache = new Map();

function expensiveOperation(key) {
  if (cache.has(key)) {
    return cache.get(key);
  }
  
  const result = performExpensiveOperation(key);
  cache.set(key, result);
  return result;
}
```

## 插件发布

### 1. 版本管理

```json
// package.json 或 manifest.json
{
  "version": "1.0.0",
  "changelog": {
    "1.0.0": "Initial release",
    "1.0.1": "Bug fixes",
    "1.1.0": "New features"
  }
}
```

### 2. 文档编写

为每个插件创建 README.md：

```markdown
# My Plugin

## 功能描述
- 功能 1
- 功能 2

## 安装方法
1. 复制插件到 plugins 目录
2. 重启应用

## 使用方法
```javascript
// 调用示例
const result = await window.api.callPlugin('my-plugin', 'myAction', params);
```

## API 文档
- `myAction(params)` - 执行主要功能
- `getData()` - 获取数据
```

这个插件开发指南为开发者提供了完整的插件开发流程，从基础概念到高级技巧，帮助快速上手 Airdropz 插件开发。
