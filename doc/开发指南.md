# 使用说明：基于 Electron + Next.js + Crawlee + PouchDB + Python 插件的框架开发指南

## 概述

此框架结合了 Electron（桌面应用）、Next.js（React 前端）、Crawlee（网页爬取）、PouchDB（本地数据库）和 Python 插件（代理管理），适用于构建支持插件化、数据存储和网络爬取的桌面应用。以下是开发流程、功能使用和扩展方法的详细指南。

## 1. 环境准备

确保你的开发环境已配置如下：

- **Node.js 和 npm**：最新稳定版（例如 v20.x）。
- **Electron Forge**：通过 package.json 中的脚本（如 npm run dev）运行。
- **Python 3**：安装并确保 python3 命令可用（brew install python@3.13）。
- **依赖**：运行 npm install 安装 electron, crawlee, pouchdb, pluggable-electron 等。
- **IDE**：推荐 VS Code，安装 TypeScript 和 ESLint 插件。

## 2. 项目结构

熟悉以下关键目录和文件：

### electron/：
- **main.js**：主进程入口，管理窗口和 IPC。
- **pluginManager.js**：插件管理系统，加载 Python 插件。
- **browserService.js**：Crawlee 爬虫服务，集成代理。
- **preload.js**：预加载脚本，暴露 API 到渲染器。

### src/app/：
- Next.js 页面（如 page.tsx）。

### plugins/：
- 插件目录，包含 proxy-manager/（Python 代理管理）。

## 3. 核心功能使用

### 3.1 启动应用

运行：
```bash
npm run dev
```

应用将打开一个窗口，加载 http://localhost:3000（开发模式）。
终端显示日志，确认 pluggable-electron, Plugin system, 和 Proxy manager 初始化。

### 3.2 数据存储（PouchDB）

**API 使用：**

在 src/app/page.tsx 中调用 window.api.dbPut 和 window.api.dbGet：

```tsx
'use client';

import { useEffect, useState } from 'react';

export default function Home() {
  const [data, setData] = useState<any>(null);

  useEffect(() => {
    if (window.api) {
      window.api.dbPut({ _id: 'test', data: 'Hello World' })
        .then(() => window.api.dbGet('test'))
        .then((doc) => setData(doc))
        .catch((error) => console.error('DB error:', error));
    }
  }, []);

  return <div>{data ? `Data: ${data.data}` : 'Loading...'}</div>;
}
```

**功能**：本地存储键值对，dbPut 创建/更新文档，dbGet 读取文档。

### 3.3 网页爬取（Crawlee）

**API 使用：**

调用 window.api.scrape 爬取网页：

```tsx
'use client';

import { useEffect, useState } from 'react';

export default function Home() {
  const [scrapeResult, setScrapeResult] = useState<string | null>(null);

  useEffect(() => {
    if (window.api) {
      window.api.scrape('https://example.com')
        .then((result) => setScrapeResult(result))
        .catch((error) => console.error('Scrape error:', error));
    }
  }, []);

  return <div>{scrapeResult ? `Scrape Result: ${scrapeResult}` : 'Loading...'}</div>;
}
```

**功能**：通过 Crawlee 爬取网页，支持代理（由 Python 提供）。
**选项**：options 可传 headless: false 启用头显模式。

### 3.4 代理管理（Python 插件）

**当前实现**：proxy_manager.py 提供代理列表，browserService.js 动态获取。
**使用**：scrape 自动使用代理，无需手动配置。

**扩展：**

修改 plugins/proxy-manager/proxy_manager.py 添加更多代理：

```python
import sys
import json
import random

proxies = [
    {"host": "proxy1.example.com", "port": 8080, "auth": "user1:pass1"},
    {"host": "proxy2.example.com", "port": 8081, "auth": "user2:pass2"},
    {"host": "proxy3.example.com", "port": 8082, "auth": "user3:pass3"}
]

for line in sys.stdin:
    if line.strip() == "get_next_proxy":
        proxy = random.choice(proxies)
        print(json.dumps(proxy))
        sys.stdout.flush()
```

重启应用（npm run dev）以应用更改。

## 4. 开发流程

### 4.1 添加新功能

- **PouchDB**：修改 main.js 的 ipcMain.handle 添加新方法（e.g., dbDelete）。
- **Crawlee**：扩展 browserService.js 的 scrape 方法，支持更多选项（如 maxRequestsPerCrawl）。
- **Python 插件**：在 plugins/ 添加新目录（如 plugin-new/），创建 manifest.json 和脚本，重启应用。

### 4.2 调试

- **日志**：检查终端输出，console.log 提供详细信息。
- **DevTools**：在窗口按 Ctrl+Shift+I 打开开发者工具，测试 window.api 方法。
- **文件检查**：确保 plugins/ 文件复制到 app.getPath('userData')/plugins/。

### 4.3 打包

运行：
```bash
npm run make
```

配置 forge.config.js 的 extraResources 复制 plugins/：

```javascript
extraResources: ['./plugins/**/*'],
afterCopy: [
  (buildPath) => {
    const fs = require('fs-extra');
    const userDataPath = path.join(buildPath, 'resources/app.asar.unpacked/userData/plugins');
    fs.copySync('./plugins', userDataPath);
  },
],
```

生成的 .dmg 或 .exe 文件包含所有功能。

## 5. 扩展和优化

- **JS 插件**：使用 pluggable-electron.usePlugins 添加 JavaScript 插件。
- **类型安全**：为 preload.js 添加 TypeScript 类型定义（types/preload.d.ts）。
- **代理旋转**：修改 ProxyConfiguration 启用 rotateProxies: true，优化 getProxyUrl。
- **错误处理**：在 main.js 添加 process.on('uncaughtException', ...) 捕获同步错误。

## 6. 常见问题及解决

- **Python 进程未启动**：检查 python3 路径，复制文件至用户数据目录。
- **代理未生效**：验证 proxy_manager.py 输出 JSON，确保 scrape 返回数据。
- **窗口未加载**：检查 main.js 的 loadURL 或 loadFile 路径。

## 7. 下一步建议

- **测试**：运行 window.api.scrape 和 window.api.dbGet 验证功能。
- **文档**：为新插件添加 README。
- **CI/CD**：设置 GitHub Actions 自动打包。
