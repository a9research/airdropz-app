# Airdropz 开发指南

## 环境准备

### 系统要求

- **Node.js**: 20.x 或更高版本
- **Python**: 3.13 或更高版本
- **操作系统**: Windows 10+, macOS 10.15+, Ubuntu 18.04+
- **内存**: 至少 4GB RAM
- **存储**: 至少 2GB 可用空间

### 开发工具推荐

- **IDE**: Visual Studio Code
- **插件**: 
  - TypeScript 和 JavaScript 语言支持
  - Python 语言支持
  - ESLint 代码检查
  - Prettier 代码格式化
- **版本控制**: Git

### 安装依赖

```bash
# 克隆项目
git clone <repository-url>
cd framework

# 安装 Node.js 依赖
npm install

# 安装 Python 依赖
pip install pyinstaller
```

## 项目结构详解

```
framework/
├── electron/                 # Electron 主进程代码
│   ├── main.js              # 应用入口点
│   ├── pluginManager.js     # 插件管理系统
│   ├── browserService.js    # 网页爬取服务
│   └── preload.js           # 预加载脚本
├── src/                     # Next.js 前端源码
│   ├── app/                 # Next.js 13+ App Router
│   │   ├── page.tsx         # 主页面
│   │   ├── layout.tsx       # 布局组件
│   │   └── globals.css      # 全局样式
│   ├── components/          # React 组件
│   ├── hooks/               # 自定义 Hooks
│   ├── lib/                 # 工具库
│   └── types/               # TypeScript 类型定义
├── plugins/                 # 插件目录
│   ├── proxy-browser/       # JavaScript 插件示例
│   │   ├── index.js         # 插件主文件
│   │   └── manifest.json    # 插件配置
│   └── proxy-manager/       # Python 插件示例
│       ├── proxy_manager.py # Python 脚本
│       └── manifest.json    # 插件配置
├── public/                  # 静态资源
│   ├── icon.icns           # macOS 图标
│   ├── icon.ico            # Windows 图标
│   └── icon.png            # Linux 图标
├── doc/                     # 项目文档
├── .github/workflows/       # GitHub Actions 配置
├── package.json             # 项目配置
├── forge.config.js          # Electron Forge 配置
└── tsconfig.json           # TypeScript 配置
```

## 开发工作流

### 1. 启动开发环境

```bash
# 启动开发服务器
npm run dev

# 这将同时启动：
# - Next.js 开发服务器 (http://localhost:3000)
# - Electron 应用
```

### 2. 开发模式特性

- **热重载**: 前端代码修改后自动刷新
- **开发工具**: 可启用 Electron 开发者工具
- **调试支持**: 支持断点调试
- **日志输出**: 控制台显示详细日志

### 3. 构建和打包

```bash
# 构建 Next.js 应用
npm run build

# 打包 Electron 应用
npm run make

# 仅打包（不生成安装包）
npm run package
```

## 核心开发概念

### 1. 进程间通信 (IPC)

#### 主进程到渲染进程

```javascript
// electron/main.js
const { ipcMain } = require('electron');

ipcMain.handle('api-name', async (event, ...args) => {
  // 处理逻辑
  return result;
});
```

#### 渲染进程到主进程

```typescript
// src/app/page.tsx
const result = await window.api.apiName(args);
```

#### 预加载脚本

```javascript
// electron/preload.js
const { contextBridge, ipcRenderer } = require('electron');

contextBridge.exposeInMainWorld('api', {
  apiName: (...args) => ipcRenderer.invoke('api-name', ...args),
});
```

### 2. 插件系统集成

#### 注册插件动作

```javascript
// plugins/my-plugin/index.js
module.exports = (context) => {
  const myAction = async (param) => {
    // 插件逻辑
    return result;
  };

  return {
    init() {
      context.registerAction('myAction', myAction);
    }
  };
};
```

#### 调用插件动作

```javascript
// electron/main.js
ipcMain.handle('plugin-action', async (event, action, ...args) => {
  const plugin = pluggableElectron.usePlugins().find(p => p.actions && p.actions[action]);
  if (plugin && plugin.actions[action]) {
    return await plugin.actions[action](...args);
  }
  throw new Error(`Action ${action} not found`);
});
```

### 3. 数据存储

#### PouchDB 操作

```javascript
// electron/main.js
const PouchDB = require('pouchdb');
const db = new PouchDB('mydb');

// 存储数据
ipcMain.handle('db-put', async (event, doc) => db.put(doc));

// 获取数据
ipcMain.handle('db-get', async (event, id) => db.get(id));
```

#### 前端使用

```typescript
// src/app/page.tsx
const saveData = async (data) => {
  await window.api.dbPut(data);
};

const loadData = async (id) => {
  return await window.api.dbGet(id);
};
```

### 4. 网页爬取

#### 浏览器服务

```javascript
// electron/browserService.js
const { PlaywrightCrawler } = require('crawlee');

async scrape(url, options = {}) {
  const crawler = new PlaywrightCrawler({
    requestHandler: async ({ page, request }) => {
      await page.goto(request.url);
      return await page.evaluate(() => document.body.innerText);
    },
    headless: options.headless ?? false,
  });
  
  await crawler.run([url]);
  return await crawler.getData();
}
```

## 前端开发

### 1. React 组件开发

```typescript
// src/components/MyComponent.tsx
'use client';

import { useState, useEffect } from 'react';

interface MyComponentProps {
  title: string;
  onAction?: () => void;
}

export default function MyComponent({ title, onAction }: MyComponentProps) {
  const [data, setData] = useState<string | null>(null);

  useEffect(() => {
    // 组件挂载时的逻辑
  }, []);

  return (
    <div className="p-4">
      <h2 className="text-xl font-bold">{title}</h2>
      <button 
        onClick={onAction}
        className="px-4 py-2 bg-blue-500 text-white rounded"
      >
        执行操作
      </button>
    </div>
  );
}
```

### 2. 自定义 Hooks

```typescript
// src/hooks/useApi.ts
import { useState, useEffect } from 'react';

export function useApi<T>(apiCall: () => Promise<T>) {
  const [data, setData] = useState<T | null>(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<Error | null>(null);

  useEffect(() => {
    apiCall()
      .then(setData)
      .catch(setError)
      .finally(() => setLoading(false));
  }, []);

  return { data, loading, error };
}
```

### 3. 类型定义

```typescript
// src/types/api.ts
export interface ApiResponse<T> {
  success: boolean;
  data: T;
  error?: string;
}

export interface PluginAction {
  name: string;
  description: string;
  parameters: Record<string, any>;
}
```

## 调试技巧

### 1. 启用开发者工具

```javascript
// electron/main.js
if (process.env.NODE_ENV === 'development') {
  mainWindow.webContents.openDevTools();
}
```

### 2. 日志调试

```javascript
// 主进程日志
console.log('Main process log:', data);

// 渲染进程日志
console.log('Renderer process log:', data);
```

### 3. 断点调试

- 在 VS Code 中设置断点
- 使用 `debugger` 语句
- 配置 launch.json 进行调试

## 性能优化

### 1. 代码分割

```typescript
// 动态导入组件
const LazyComponent = dynamic(() => import('./LazyComponent'), {
  loading: () => <div>Loading...</div>
});
```

### 2. 内存管理

```javascript
// 清理事件监听器
window.addEventListener('beforeunload', () => {
  // 清理逻辑
});
```

### 3. 资源优化

- 使用 WebP 图片格式
- 压缩静态资源
- 启用 gzip 压缩

## 测试

### 1. 单元测试

```bash
# 安装测试依赖
npm install --save-dev jest @testing-library/react

# 运行测试
npm test
```

### 2. 集成测试

```javascript
// tests/integration/api.test.js
describe('API Integration', () => {
  test('should handle data storage', async () => {
    const result = await window.api.dbPut({ id: 'test', data: 'value' });
    expect(result).toBeDefined();
  });
});
```

## 部署

### 1. 本地构建

```bash
# 构建应用
npm run build

# 打包应用
npm run make
```

### 2. GitHub Actions 部署

```yaml
# .github/workflows/build.yml
name: Build and Deploy
on:
  push:
    branches: [main]
jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [macos-latest, windows-latest]
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install dependencies
        run: npm ci
      - name: Build application
        run: npm run make
```

## 常见问题

### 1. 端口冲突

```bash
# 检查端口占用
lsof -i :3000

# 杀死进程
kill -9 <PID>
```

### 2. 依赖问题

```bash
# 清理 node_modules
rm -rf node_modules package-lock.json
npm install
```

### 3. 构建错误

- 检查 TypeScript 类型错误
- 验证所有依赖是否正确安装
- 查看构建日志中的详细错误信息

## 最佳实践

1. **代码组织**: 按功能模块组织代码
2. **错误处理**: 实现完善的错误处理机制
3. **类型安全**: 充分利用 TypeScript 类型系统
4. **性能监控**: 监控应用性能指标
5. **安全考虑**: 遵循 Electron 安全最佳实践
6. **文档维护**: 保持代码文档的更新

这个开发指南为开发者提供了完整的开发流程和最佳实践，帮助快速上手 Airdropz 系统开发。